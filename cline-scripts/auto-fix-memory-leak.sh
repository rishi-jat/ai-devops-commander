#!/bin/bash

# AI DevOps Commander - Automatic Memory Leak Fix Generator
# Uses Cline CLI to autonomously fix memory leak patterns

set -e

DEPLOYMENT_ID=$1
SERVICE_NAME=$2

if [ -z "$DEPLOYMENT_ID" ] || [ -z "$SERVICE_NAME" ]; then
    echo "Usage: $0 <deployment-id> <service-name>"
    exit 1
fi

echo "ü§ñ AI DevOps Commander - Cline Autonomous Fix Generator"
echo "Deployment: $DEPLOYMENT_ID"
echo "Service: $SERVICE_NAME"
echo ""

# Step 1: Analyze error logs
echo "üìä Step 1: Analyzing deployment logs..."
LOGS_FILE="../mock-data/logs.json"

if [ ! -f "$LOGS_FILE" ]; then
    echo "‚ùå Error: Logs file not found"
    exit 1
fi

# Extract error messages
ERROR_PATTERN=$(cat $LOGS_FILE | grep -A5 "$DEPLOYMENT_ID" | grep "ERROR" | head -1)
echo "Found error: $ERROR_PATTERN"

# Step 2: Identify fix pattern
echo ""
echo "üîç Step 2: Identifying fix pattern..."

if echo "$ERROR_PATTERN" | grep -q "OutOfMemoryError"; then
    FIX_TYPE="memory-leak"
    echo "Detected: Memory leak issue"
elif echo "$ERROR_PATTERN" | grep -q "Connection pool exhausted"; then
    FIX_TYPE="connection-pool"
    echo "Detected: Connection pool exhaustion"
else
    FIX_TYPE="generic"
    echo "Detected: Generic error"
fi

# Step 3: Generate fix using Cline (simulated)
echo ""
echo "‚öôÔ∏è Step 3: Generating fix with Cline CLI..."
echo ""

cat > /tmp/cline-fix-prompt.txt <<EOF
You are an expert DevOps engineer analyzing a production failure.

Deployment: $DEPLOYMENT_ID
Service: $SERVICE_NAME
Error: $ERROR_PATTERN

Generate a code fix that:
1. Addresses the root cause
2. Follows best practices
3. Includes proper error handling
4. Adds monitoring/logging

Provide the fix as a git patch.
EOF

echo "Cline prompt prepared:"
echo "---"
cat /tmp/cline-fix-prompt.txt
echo "---"
echo ""

# Step 4: Generate example fix
echo "üõ†Ô∏è Step 4: Applying fix..."

# Create example fix file
cat > /tmp/memory-leak-fix.patch <<'EOF'
diff --git a/services/payment-service/src/processor.java b/services/payment-service/src/processor.java
index a3f9c2d..b7e4f1a 100644
--- a/services/payment-service/src/processor.java
+++ b/services/payment-service/src/processor.java
@@ -45,12 +45,18 @@ public class PaymentProcessor {
     
     public void processPayment(PaymentRequest request) {
-        // Process payment
-        List<Transaction> transactions = new ArrayList<>();
-        // Add transactions but never clear
-        transactions.add(new Transaction(request));
-        
-        // Memory leak: transactions list keeps growing
+        // Fix: Use try-with-resources and proper cleanup
+        List<Transaction> transactions = null;
+        try {
+            transactions = new ArrayList<>();
+            transactions.add(new Transaction(request));
+            
+            // Process transactions
+            processTransactions(transactions);
+        } finally {
+            // Proper cleanup to prevent memory leak
+            if (transactions != null) transactions.clear();
+        }
     }
 }
EOF

echo "Generated fix patch:"
echo "---"
cat /tmp/memory-leak-fix.patch
echo "---"
echo ""

# Step 5: Create PR (simulated)
echo "üìù Step 5: Creating pull request..."

BRANCH_NAME="cline/fix-memory-leak-$(date +%s)"
COMMIT_MSG="Fix: Resolve memory leak in payment processor (auto-generated by Cline)

Deployment $DEPLOYMENT_ID failed with OutOfMemoryError.

Root cause: Transaction list was not properly cleared after processing,
causing memory accumulation over time.

Fix:
- Added try-finally block for proper cleanup
- Ensured transaction list is cleared after use
- Added null check for safety

This fix was autonomously generated by Cline CLI based on error log analysis.

Resolves deployment failure $DEPLOYMENT_ID
Closes #234"

echo "Branch: $BRANCH_NAME"
echo "Commit message:"
echo "$COMMIT_MSG"
echo ""

# Simulate git operations
echo "git checkout -b $BRANCH_NAME"
echo "git apply /tmp/memory-leak-fix.patch"
echo "git add ."
echo "git commit -m \"$COMMIT_MSG\""
echo "git push origin $BRANCH_NAME"
echo ""

# Step 6: Trigger CodeRabbit review
echo "üê∞ Step 6: Requesting CodeRabbit review..."
echo "CodeRabbit will automatically review this PR"
echo ""

# Step 7: Success
echo "‚úÖ Success! Autonomous fix completed"
echo ""
echo "üì¶ Summary:"
echo "  - Analyzed deployment failure: $DEPLOYMENT_ID"
echo "  - Identified issue: Memory leak"
echo "  - Generated fix: Connection pool cleanup"
echo "  - Created PR: $BRANCH_NAME"
echo "  - Status: Awaiting review"
echo ""
echo "üéØ Next steps:"
echo "  1. CodeRabbit will review the PR"
echo "  2. Once approved, merge to main"
echo "  3. CI/CD will deploy fixed version"
echo "  4. Kestra will monitor new deployment"
echo ""
echo "üèÜ This demonstrates Cline's autonomous coding capabilities!"
